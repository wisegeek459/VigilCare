<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VigilCare - Submit Incident</title>

  <!-- Load Google Identity Services (GIS) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Load Google API Client Library -->
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <div class="form-container">
    <h2>Submit a New Incident</h2>
    <form id="incident-form">
      <label for="patient-name">Patient Name</label>
      <input type="text" id="patient-name" required>

      <label for="attendant-name">Attendant Name</label>
      <input type="text" id="attendant-name" required>

      <label for="incident-type">Incident Type</label>
      <select id="incident-type">
        <option value="Verbal Abuse">Verbal Abuse</option>
        <option value="Physical Violence">Physical Violence</option>
        <option value="Property Damage">Property Damage</option>
      </select>

      <label for="incident-description">Incident Description</label>
      <textarea id="incident-description" rows="4"></textarea>

      <button type="submit">Submit</button>
    </form>

    <!-- Google Sign-In Button -->
    <div id="g_id_onload"
         data-client_id="959824072139-lroeeknsfvsmtgnqmtkokm02g1ggqbbe.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-scope="https://www.googleapis.com/auth/spreadsheets"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>

    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <script>
    let accessToken = null;

    // Handle GIS Sign-In Response
    function handleCredentialResponse(response) {
      console.log("Received ID Token: ", response.credential);

      // Exchange ID Token for OAuth Access Token
      const body = new URLSearchParams();
      body.append('client_id', '959824072139-lroeeknsfvsmtgnqmtkokm02g1ggqbbe.apps.googleusercontent.com');
      body.append('grant_type', 'authorization_code');
      body.append('code', response.credential); // Assuming OAuth Code Flow
      body.append('redirect_url', 'https://wisegeek459.github.io/VigilCare/incident.html');

      fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: body
      })
      .then(response => response.json())
      .then(data => {
        if (data.access_token) {
          accessToken = data.access_token;
          console.log("OAuth Access Token: ", accessToken);
          initializeGoogleSheetsAPI();
        } else {
          console.error("Failed to retrieve access token:", data);
          alert("Failed to sign in.");
        }
      })
      .catch(error => {
        console.error("Error exchanging token:", error);
        alert("Error during sign-in.");
      });
    }

    // Initialize Google Sheets API
    function initializeGoogleSheetsAPI() {
      gapi.client.init({
        apiKey: 'AIzaSyARlGRuTLNmrqLiplRsIq1xyq5pm86ge7c',
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
      }).then(() => {
        console.log("Google Sheets API initialized.");
      }).catch(error => {
        console.error("Error initializing Google API client:", error);
      });
    }

    // Write Data to Google Sheets
    function writeDataToSheet(values) {
      if (!accessToken) {
        alert("Please sign in first.");
        return;
      }

      gapi.client.request({
        path: `https://sheets.googleapis.com/v4/spreadsheets/1FY5Cq9wJZCHVzlFcOQb6Mj3EAa-RvBQ4aD9KFa11elI/values/Incidents:append`,
        method: 'POST',
        params: {
          valueInputOption: 'RAW',
          insertDataOption: 'INSERT_ROWS'
        },
        headers: {
          'Authorization': `Bearer ${accessToken}`
        },
        body: {
          values: [values]
        }
      }).then(response => {
        console.log("Data appended successfully:", response);
        alert("Incident submitted successfully!");
      }).catch(error => {
        console.error("Error appending data:", error);
        alert("Failed to submit incident.");
      });
    }

    // Handle Form Submission
    document.getElementById('incident-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const patientName = document.getElementById('patient-name').value;
      const attendantName = document.getElementById('attendant-name').value;
      const incidentType = document.getElementById('incident-type').value;
      const incidentDescription = document.getElementById('incident-description').value;
      const timestamp = new Date().toLocaleString();

      const data = [patientName, attendantName, incidentType, incidentDescription, timestamp];

      writeDataToSheet(data);
    });
  </script>
</body>
</html>
