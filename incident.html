<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VigilCare - Submit Incident</title>
  <link rel="stylesheet" href="styles.css">
  
  <!-- Load Google Identity Services (GIS) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <!-- Load Google API Client Library -->
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <div class="form-container">
    <h2>Submit a New Incident</h2>
    <form id="incident-form">
      <label for="patient-name">Patient Name</label>
      <input type="text" id="patient-name" placeholder="Enter patient's name" required>

      <label for="attendant-name">Attendant Name</label>
      <input type="text" id="attendant-name" placeholder="Enter attendant's name" required>

      <label for="incident-type">Incident Type</label>
      <select id="incident-type">
        <option value="Verbal Abuse">Verbal Abuse</option>
        <option value="Physical Violence">Physical Violence</option>
        <option value="Property Damage">Property Damage</option>
      </select>

      <label for="incident-description">Incident Description</label>
      <textarea id="incident-description" rows="4" placeholder="Describe the incident"></textarea>

      <button type="submit">Submit</button>
    </form>

    <!-- Google Sign-In Button using GIS -->
    <div id="g_id_onload"
         data-client_id="959824072139-lroeeknsfvsmtgnqmtkokm02g1ggqbbe.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <script>
    let gapiInited = false;
    let accessToken = null;

    // Ensure Google API client is loaded and initialize OAuth2
    function loadGapiClient() {
      return new Promise((resolve, reject) => {
        gapi.load('client:auth2', () => {
          gapi.auth2.init({
            client_id: '959824072139-lroeeknsfvsmtgnqmtkokm02g1ggqbbe.apps.googleusercontent.com',
          }).then(() => {
            gapiInited = true;
            console.log("Google Auth2 client initialized.");
            resolve();
          }).catch((error) => {
            console.error("Error initializing Google Auth2:", error);
            reject(error);
          });
        });
      });
    }

    // Handle the response from Google Identity Services (GIS)
    function handleCredentialResponse(response) {
      console.log("Encoded JWT ID token: " + response.credential);

      // Initialize Google API client and authenticate
      loadGapiClient().then(() => {
        // Ensure Auth2 is initialized before calling signIn
        const authInstance = gapi.auth2.getAuthInstance();
        if (authInstance) {
          authInstance.signIn().then((user) => {
            accessToken = user.getAuthResponse().access_token;
            console.log("OAuth2 Access Token received: " + accessToken);
            alert("Signed in successfully!");
          }).catch((error) => {
            console.error("Error during sign-in:", error);
          });
        } else {
          console.error("Auth2 instance not available.");
        }
      });
    }

    // Function to write data to Google Sheets using OAuth2 token
    function writeDataToSheet(values) {
      console.log("Attempting to write data to Google Sheets...");

      const params = {
        spreadsheetId: '1FY5Cq9wJZCHVzlFcOQb6Mj3EAa-RvBQ4aD9KFa11elI',  // Your Google Sheets ID
        range: 'Incidents!A1',  // The range to append data to
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS'
      };

      const body = {
        values: [values]
      };

      // Use gapi.client.sheets with OAuth2 token
      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: params.spreadsheetId,
        range: params.range,
        valueInputOption: params.valueInputOption,
        insertDataOption: params.insertDataOption,
        resource: body
      }).then((response) => {
        console.log('Success:', response);
        alert('Incident submitted successfully to Google Sheets!');
      }, (error) => {
        console.error('Error writing data to Google Sheets:', error);
        alert('Failed to submit the incident.');
      });
    }

    // Handle form submission
    document.getElementById('incident-form').addEventListener('submit', function(e) {
      e.preventDefault();
      console.log("Form submission triggered.");

      const patientName = document.getElementById('patient-name').value;
      const attendantName = document.getElementById('attendant-name').value;
      const incidentType = document.getElementById('incident-type').value;
      const incidentDescription = document.getElementById('incident-description').value;

      // Prepare the data to send to Google Sheets
      const incidentData = [
        patientName,
        attendantName,
        incidentType,
        incidentDescription,
        new Date().toLocaleString()  // Add a timestamp
      ];

      console.log("Incident data prepared: ", incidentData);

      // Ensure OAuth token is available before writing data
      if (accessToken) {
        writeDataToSheet(incidentData);
      } else {
        console.error("Access Token is missing. Please sign in.");
        alert("Please sign in to submit the incident.");
      }
    });

  </script>
</body>
</html>
